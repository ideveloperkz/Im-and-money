# РЕАЛИЗОВАННЫЕ ФУНКЦИИ (IMPLEMENTED)

Данный документ описывает текущее состояние проекта и служит справочником для разработчиков. Проект использует модульную архитектуру на бэкенде и событийно-ориентированную модель на фронтенде.

---

## 1. Backend: Модульная Архитектура (Managers)
Основная логика разделена на специализированные менеджеры в `server/models/managers/`. `GameState.js` выступает в роли фасада.

### 1.1. PlayerManager (Управление игроками)
*   `addPlayer(data)`: Регистрация игрока, назначение UUID и цвета (муравья).
*   `removePlayer(id)`: Корректное удаление игрока при дисконнекте.
*   `connectCurator(data)`: Авторизация наблюдателя/куратора.
*   `getAvailableAntColor()`: Логика выдачи свободного цвета фишки.

### 1.2. TurnManager (Игровой цикл)
*   `startGame()`: Инициализация колод, выбор первого игрока, перевод статуса в `in_progress`.
*   `nextTurn()`: Передача хода. Обработка пропусков («арест») и «спящих» игроков.
*   `rollDice(id)`: Двухфазный расчет броска. Поддержка интерактива (2 клика) при активном бонусе благотворительности.
*   `generateReport()`: Сбор итоговой статистики для куратора.

### 1.3. MovementManager (Перемещение)
*   `movePlayer(id, steps)`: Физическое перемещение по графу клеток. Фиксация пройденных клеток «Деньги».
*   `predictMove(id, steps)`: Расчет будущей позиции для подсветки пути на клиенте.
*   `setForkDirection(id, dir)`: Сохранение выбора пути на развилке после броска монетки.

### 1.4. FinanceManager (Финансовая логика)
*   `applyMoneyChange(id, amount, ...)`: Изменение баланса с авто-распределением по 4-м кошелькам (Сбережения, Мечта, Благотворительность, Инвестиции).
*   `collectBusinessIncome(id)`: Сбор пассивного дохода от всех купленных активов.
*   `spendFromWallets(id, amount, ...)`: Логика списания средств с учетом приоритетов кошельков (Инвестиции -> Сбережения).
*   `buyBusiness(id, data)`: Регистрация покупки бизнеса/актива.
*   `updatePlayerFinances(id, data)`: Синхронизация «ручного» бланка игрока с серверными данными.
*   `cascadingSpend(id, amount)`: Каскадное списание средств при крупных покупках.

### 1.5. CellManager & CardService (События)
*   `handleCell(id, cellKey)`: Точка входа. Обработка стандартных (карты) и сложных клеток (JSON-driven).
*   `handleComplexCell(...)`: Логика сложных клеток (Штрафы, Доходы, Мечты).
    *   `income_blocked_generic`: Блокировка дохода (штраф) на N ходов.
    *   `charity_bonus`: Активация бонуса "Двойной кубик" за накопленные добрые дела.
    *   `dream_check`: Логика покупки Мечты (своей или чужой как актив).
*   `drawCard(id, type)`: Вытягивание карты через `CardService`.
*   `processCard(card, ...)`: Валидация требований (Навыки, Активы) и применение эффектов.
*   `addSkill(player, skill)`: Механика получения навыков.

### 1.6. GameState (Состояние)
*   `autoFinanceCards`: Серверный дубликат финансовой карточки каждого игрока (расчет доходов/расходов).
*   `turnTimers`: Таймер хода (3 минуты) с автоматическим переводом игрока в режим "Сна" (`isSleeping`).

---

## 2. Frontend: Синхронизация и UI

### 2.1. Единая Очередь Событий (UEQ)
Все модальные окна (карты, уведомления, результаты кубика) проходят через глобальную очередь `window.eventQueue` в `gameclient.js`. Это гарантирует, что сообщения не будут перекрывать друг друга.
*   `addToEventQueue(eventData)`: Добавление события в очередь.
*   `processEventQueue()`: Поочередный вывод окон.
*   `showUnifiedWindow(data)`: Универсальное окно для отображения любого игрового события.

### 2.2. Анимации
*   `DiceGame.showDiceAnimation()`: 3D-анимация вращения кубика (`diceanimation.js`). Поддержка промежуточных бросков (`isPartial`).
*   `CoinGame.flipCoin()`: Анимация подбрасывания монетки (`coinanimation.js`).
*   `PlayerGame.movePlayerFigure()`: Плавное перемещение фишки муравья по клеткам (`playeranimation.js`).

### 2.3. Финансовая Карточка
Интерактивный интерфейс (`board.js` + `finance_card.css`) для управления бюджетом.
*   **Автозаполнение**: Синхронизация ручного учета с серверными данными одной кнопкой.
*   **Прогресс мечты**: Визуализация накоплений на выбранную цель.

### 2.4. Game Over и Victory (НОВОЕ - 2025-12-30)
Система завершения игры с визуальными эффектами.
*   `showGameOverModal(winners)`: Модальное окно с информацией о победителях (`gameclient.js`, строки 1478-1532).
*   `launchCelebration()`: Анимация салюта (confetti) при победе (`gameclient.js`, строки 1534-1568).
*   Событие `game:game_over`: Серверное уведомление о завершении игры с данными победителей.
*   Автоматическое закрытие панели куратора перед показом модалки.
*   z-index салюта = 999999 для отображения поверх всех элементов.

### 2.5. Управление кнопками куратора (ВОССТАНОВЛЕНО - 2025-12-30)
Куратор может скрывать/показывать кнопку управления игрой у всех игроков.
*   Обработчики `curator-hide-controls-btn` и `curator-show-controls-btn` (`gameclient.js`, строки 1352-1382).
*   События `game:hide_controls` и `game:show_controls` для синхронизации.
*   Флаг `window.buttonExplicitlyHidden` для защиты от случайного показа кнопки.
*   Проверка флага в `updateHostButton` (строка 552-556).

---

## 3. Файлы Данных
*   `server/board.js`: Карта игрового поля (56 клеток, связи `next`).
*   `server/data/cells.json`: Конфигурация специальных клеток (Штрафы, Монетки, Доходы).
*   `server/data/cards/`: JSON-файлы с текстами и эффектами карточек.
    *   **ВАЖНО**: Используется поле `monthlyIncome` для дохода от бизнесов (исправлено 2025-12-30).

---

## 4. Недавние исправления

### 4.1. Исправление бага с доходом от бизнесов (2025-12-30)
**Проблема**: Код не читал поле `monthlyIncome` из JSON, из-за чего все бизнесы сохранялись с доходом 0.  
**Решение**: Добавлена поддержка `monthlyIncome` в `FinanceManager.js`:
*   Строка 128: Сбор дохода от бизнесов
*   Строка 352: Парсинг дохода при покупке

### 4.2. Улучшенная синхронизация кнопок (2025-12-30)
**Изменения**:
*   `updateHostButton` вызывается в `updateCuratorPanel`
*   `updateHostButton` вызывается в auth callbacks (player и curator)
*   Проверка флага `buttonExplicitlyHidden` для предотвращения случайного показа скрытой кнопки

---

> [!NOTE]
> При добавлении новой функции всегда сначала проверяйте `DICTIONARY.md` на наличие похожих имен и обновляйте `FILE_MAP.md` после реализации.

